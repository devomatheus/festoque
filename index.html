<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Restoque - Sistema de Controle de Estoque</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .upload-area {
            border: 2px dashed #dee2e6;
            border-radius: 10px;
            padding: 2rem;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        .upload-area:hover {
            border-color: #0d6efd;
            background-color: #f8f9fa;
        }
        .upload-area.dragover {
            border-color: #0d6efd;
            background-color: #e3f2fd;
        }
        .table-container {
            max-height: 500px;
            overflow-y: auto;
        }
        .column-selector {
            background-color: #f8f9fa;
            border-radius: 10px;
            padding: 1rem;
            margin-bottom: 1rem;
        }
        .column-btn {
            margin: 0.25rem;
        }
        .selected-columns {
            background-color: #e3f2fd;
            border-radius: 10px;
            padding: 1rem;
            margin-bottom: 1rem;
        }
        .loading {
            display: none;
        }
        .loading.show {
            display: block;
        }
        .alert-custom {
            border-radius: 10px;
        }
        .btn-custom {
            border-radius: 8px;
            padding: 0.5rem 1rem;
        }
        .card-custom {
            border-radius: 15px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
    </style>
</head>
<body class="bg-light">
    <div class="container-fluid py-4">
        <div class="row justify-content-center">
            <div class="col-12 col-lg-10">
                <!-- Header -->
                <div class="text-center mb-4">
                    <h1 class="display-4 text-primary">
                        <i class="fas fa-boxes"></i> Restoque
                    </h1>
                    <p class="lead text-muted">Sistema de Controle de Estoque</p>
                </div>

                <!-- Upload Section -->
                <div class="card card-custom mb-4">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">
                            <i class="fas fa-upload"></i> Upload de Planilha Excel
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="upload-area" id="uploadArea">
                            <i class="fas fa-cloud-upload-alt fa-3x text-muted mb-3"></i>
                            <h5>Arraste e solte sua planilha aqui</h5>
                            <p class="text-muted">ou clique no botão abaixo para selecionar</p>
                            <input type="file" id="fileInput" accept=".xlsx,.xls" style="display: none;">
                            <button class="btn btn-primary btn-lg btn-custom" id="selectFileBtn">
                                <i class="fas fa-folder-open"></i> Selecionar Arquivo Excel
                            </button>
                        </div>
                        <div class="loading text-center mt-3">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Processando...</span>
                            </div>
                            <p class="mt-2">Processando arquivo...</p>
                        </div>
                    </div>
                </div>

                <!-- Alerts -->
                <div id="alertContainer"></div>

                <!-- Column Selector -->
                <div class="card card-custom mb-4" id="columnSelectorCard" style="display: none;">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0">
                            <i class="fas fa-columns"></i> Selecionar Colunas
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="column-selector">
                            <h6>Colunas Disponíveis:</h6>
                            <div id="availableColumns"></div>
                        </div>
                        <div class="selected-columns">
                            <h6>Ordem das Colunas:</h6>
                            <div id="selectedColumns"></div>
                        </div>
                    </div>
                </div>

                <!-- Data Table -->
                <div class="card card-custom mb-4" id="dataTableCard" style="display: none;">
                    <div class="card-header bg-info text-white d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="fas fa-table"></i> Dados Processados
                        </h5>
                        <div>
                            <button class="btn btn-light btn-sm me-2" id="exportExcelBtn">
                                <i class="fas fa-file-excel"></i> Exportar Excel
                            </button>
                            <button class="btn btn-light btn-sm" id="exportPdfBtn">
                                <i class="fas fa-file-pdf"></i> Exportar PDF
                            </button>
                        </div>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-container">
                            <table class="table table-striped table-hover mb-0" id="dataTable">
                                <thead class="table-dark sticky-top">
                                    <tr id="tableHeader"></tr>
                                </thead>
                                <tbody id="tableBody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Instructions -->
                <div class="card card-custom">
                    <div class="card-header bg-warning text-dark">
                        <h5 class="mb-0">
                            <i class="fas fa-info-circle"></i> Instruções
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <h6>Formato da Planilha:</h6>
                                <ul class="list-unstyled">
                                    <li><i class="fas fa-check text-success"></i> Duas páginas: "Estoque" e "Tabela"</li>
                                    <li><i class="fas fa-check text-success"></i> Coluna "EAN" em ambas as páginas</li>
                                    <li><i class="fas fa-check text-success"></i> Coluna "quantidade" na página "Estoque"</li>
                                    <li><i class="fas fa-check text-success"></i> Coluna "Estoque" vazia na página "Tabela"</li>
                                </ul>
                            </div>
                            <div class="col-md-6">
                                <h6>Funcionalidades:</h6>
                                <ul class="list-unstyled">
                                    <li><i class="fas fa-check text-success"></i> Upload de planilha Excel</li>
                                    <li><i class="fas fa-check text-success"></i> Processamento automático</li>
                                    <li><i class="fas fa-check text-success"></i> Reordenação de colunas</li>
                                    <li><i class="fas fa-check text-success"></i> Exportação Excel/PDF</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Configuração da API
        // Para desenvolvimento local, use: 'http://localhost:5001/api'
        // Para produção, altere para: 'https://seu-usuario.pythonanywhere.com/api'
        const API_BASE_URL = 'https://ommnascimento.pythonanywhere.com/api';
        
        let currentData = [];
        let availableColumns = [];
        let selectedColumns = [];

        // Elementos DOM
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const loading = document.querySelector('.loading');
        const alertContainer = document.getElementById('alertContainer');
        const columnSelectorCard = document.getElementById('columnSelectorCard');
        const dataTableCard = document.getElementById('dataTableCard');
        const availableColumnsDiv = document.getElementById('availableColumns');
        const selectedColumnsDiv = document.getElementById('selectedColumns');
        const dataTable = document.getElementById('dataTable');
        const tableHeader = document.getElementById('tableHeader');
        const tableBody = document.getElementById('tableBody');
        const exportExcelBtn = document.getElementById('exportExcelBtn');
        const exportPdfBtn = document.getElementById('exportPdfBtn');
        const selectFileBtn = document.getElementById('selectFileBtn');

        // Event Listeners
        selectFileBtn.addEventListener('click', (e) => {
            e.preventDefault();
            e.stopPropagation();
            fileInput.click();
        });
        uploadArea.addEventListener('dragover', handleDragOver);
        uploadArea.addEventListener('dragleave', handleDragLeave);
        uploadArea.addEventListener('drop', handleDrop);
        fileInput.addEventListener('change', handleFileSelect);
        exportExcelBtn.addEventListener('click', (e) => {
            e.preventDefault();
            exportData('excel');
        });
        exportPdfBtn.addEventListener('click', (e) => {
            e.preventDefault();
            exportData('pdf');
        });
        
        // Tratamento de erros globais
        window.addEventListener('error', (e) => {
            console.error('Erro JavaScript:', e.error);
            showAlert(`Erro JavaScript: ${e.error.message}`, 'danger');
        });
        
        window.addEventListener('unhandledrejection', (e) => {
            console.error('Promise rejeitada:', e.reason);
            showAlert(`Erro de Promise: ${e.reason}`, 'danger');
        });

        function handleDragOver(e) {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        }

        function handleDragLeave(e) {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
        }

        function handleDrop(e) {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                processFile(files[0]);
            }
        }

        function handleFileSelect(e) {
            const file = e.target.files[0];
            if (file) {
                processFile(file);
            }
        }

        async function processFile(file) {
            if (!file.name.match(/\.(xlsx|xls)$/)) {
                showAlert('Por favor, selecione um arquivo Excel (.xlsx ou .xls)', 'danger');
                return;
            }

            const formData = new FormData();
            formData.append('file', file);

            try {
                loading.classList.add('show');
                hideAlert();

                const response = await fetch(`${API_BASE_URL}/upload`, {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    showAlert(`Erro ${response.status}: ${response.statusText}`, 'danger');
                    return;
                }
                
                const result = await response.json();

                if (result.success) {
                    currentData = result.data;
                    availableColumns = Object.keys(currentData[0] || {});
                    selectedColumns = [...availableColumns];
                    
                    showAlert('Arquivo processado com sucesso!', 'success');
                    showColumnSelector();
                    showDataTable();
                } else {
                    showAlert(result.error || 'Erro ao processar arquivo', 'danger');
                }
            } catch (error) {
                showAlert(`Erro de conexão: ${error.message}`, 'danger');
            } finally {
                loading.classList.remove('show');
            }
        }

        function showColumnSelector() {
            columnSelectorCard.style.display = 'block';
            renderColumnSelector();
        }

        function renderColumnSelector() {
            // Colunas disponíveis
            availableColumnsDiv.innerHTML = '';
            availableColumns.forEach(column => {
                if (!selectedColumns.includes(column)) {
                    const btn = document.createElement('button');
                    btn.className = 'btn btn-outline-primary btn-sm column-btn';
                    btn.textContent = column;
                    btn.onclick = () => addColumn(column);
                    availableColumnsDiv.appendChild(btn);
                }
            });

            // Colunas selecionadas
            selectedColumnsDiv.innerHTML = '';
            selectedColumns.forEach((column, index) => {
                const btn = document.createElement('button');
                btn.className = 'btn btn-primary btn-sm column-btn me-1 mb-1';
                btn.innerHTML = `${column} <i class="fas fa-times ms-1"></i>`;
                btn.onclick = () => removeColumn(index);
                selectedColumnsDiv.appendChild(btn);
            });
        }

        function addColumn(column) {
            selectedColumns.push(column);
            renderColumnSelector();
            showDataTable();
        }

        function removeColumn(index) {
            selectedColumns.splice(index, 1);
            renderColumnSelector();
            showDataTable();
        }

        function showDataTable() {
            dataTableCard.style.display = 'block';
            renderTable();
        }

        function renderTable() {
            // Cabeçalho
            tableHeader.innerHTML = '';
            selectedColumns.forEach(column => {
                const th = document.createElement('th');
                th.textContent = column;
                tableHeader.appendChild(th);
            });

            // Corpo
            tableBody.innerHTML = '';
            currentData.forEach(row => {
                const tr = document.createElement('tr');
                selectedColumns.forEach(column => {
                    const td = document.createElement('td');
                    td.textContent = row[column] || '';
                    tr.appendChild(td);
                });
                tableBody.appendChild(tr);
            });
        }

        async function exportData(format) {
            try {
                const response = await fetch(`${API_BASE_URL}/export/${format}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        data: currentData,
                        columns_order: selectedColumns
                    })
                });

                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `restoque_export_${new Date().toISOString().slice(0,10)}.${format === 'excel' ? 'xlsx' : 'pdf'}`;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                    
                    showAlert(`Arquivo ${format.toUpperCase()} exportado com sucesso!`, 'success');
                } else {
                    const error = await response.json();
                    showAlert(error.error || 'Erro ao exportar arquivo', 'danger');
                }
            } catch (error) {
                showAlert('Erro de conexão com o servidor', 'danger');
                console.error('Error:', error);
            }
        }

        function showAlert(message, type) {
            const timestamp = new Date().toLocaleTimeString();
            alertContainer.innerHTML = `
                <div class="alert alert-${type} alert-dismissible fade show alert-custom" role="alert">
                    <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-triangle'}"></i>
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;
            console.log(`[${timestamp}] ALERT: ${message}`);
        }
        
        function addPersistentLog(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            console.log(`[${timestamp}] LOG: ${message}`);
        }

        function hideAlert() {
            alertContainer.innerHTML = '';
        }

        // Verificar se a API está funcionando
        async function checkAPI() {
            try {
                console.log('Verificando API em:', `${API_BASE_URL}/health`);
                const response = await fetch(`${API_BASE_URL}/health`);
                console.log('Resposta da API:', response.status, response.statusText);
                if (!response.ok) {
                    showAlert('Servidor não está respondendo. Verifique se o backend está rodando.', 'warning');
                } else {
                    console.log('API funcionando corretamente');
                }
            } catch (error) {
                console.error('Erro ao verificar API:', error);
                showAlert('Não foi possível conectar com o servidor. Verifique se o backend está rodando.', 'warning');
            }
        }

        // Verificar API ao carregar a página
        checkAPI();
    </script>
</body>
</html>
